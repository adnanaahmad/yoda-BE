<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">

  <title>FortifID | Document Verification</title>
  <meta name="author" content="cisco@barbarians.com">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre.min.css"
    integrity="sha512-9RIcp1f4CE6dEuYX9085tXaEbYd1ap04d2Av1ub/dwuT33WbfbHStDdQ+shKrp5wzZzleh5DOg+7ABSnaQP/nQ=="
    crossorigin="anonymous" />
  <style>
    .center {
      margin: 0 auto;
    }

    hr {
      max-width: 200px;
    }

    #logo {
      width: 300px;
    }

    .w300 {
      min-width: 300px;
    }
  </style>
</head>

<body>

  <div class="container grid-lg">
    <br />

    <div class="text-center">
      <img id="logo" src="/images/logo.png" alt="FortifID Logo">
      <br /><br />
      <h5>Document Verification</h5>
      <hr />
    </div>
    <div class="w300">
      <br />
      <div id="send-verification" class="text-left d-none">

        <div class="form-group">
          <label class="form-label" for="full_name">Full Name</label>
          <input id="full_name" class="form-input" type="text" placeholder="Full Name (optional)" minlength="1"
            maxlength="64">
        </div>

        <div class="form-group">
          <label class="form-label" for="email_address">Email</label>
          <input id="email_address" class="form-input" type="email" placeholder="Email"
            pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,14}$" maxlength="64" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="phone_number">Phone Number</label>
          <input id="phone_number" class="form-input" type="tel" placeholder="Phone Number" minlength="10"
            maxlength="15" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="birth_date">Birth Date</label>
          <input id="birth_date" type="date" min="1900-01-01" max="2022-12-31" class="form-input"
            placeholder="Birth Date">
        </div>
        <div class="form-group">
          <label class="form-label" for="request_reference">Request Reference</label>
          <input id="request_reference" class="form-input" placeholder="Request Reference" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="redirect_url">Redirect Url</label>
          <input id="redirect_url" class="form-input" placeholder="Redirect Url" required>
        </div>

        <br />
        <div class="center">
          <button id="btn-url" class="p-centered veriff-submit" style="width: 350px; display: block;">Send
            Verification</button>
        </div>

      </div>
      <div>
        <div id="status" class="text-center">&nbsp;</div>
        <br />
        <div id="statu2" class="text-center">&nbsp;</div>
      </div>
      <br />
      <div id="or" class="text-center d-none">
        <strong>&mdash; or &mdash;</strong>
      </div>
      <br />
      <div id='veriff-root' class="p-centered" style="width: 350px;"></div>
      <div>
        <div id="status2" class="text-center">&nbsp;</div>
      </div>
    </div>
  </div>

  <script src='https://cdn.veriff.me/sdk/js/1.1/veriff.min.js'></script>
  <script src='https://cdn.veriff.me/incontext/js/v1/veriff.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.1/uuid.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.0.slim.min.js"
    integrity="sha256-MlusDLJIP1GRgLrOflUQtshyP0TwT/RHXsI1wWGnQhs=" crossorigin="anonymous"></script>
  <script>
    (async () => {
      "use strict";

      const MODE = 'PROD';
      const BASE_URL = `${window.location.protocol}//${window.location.hostname}/doc/v1`;
      const params = new URLSearchParams(window.location.search);
      let hasRef = params && params.has('ref');
      let transaction_id = hasRef ? params.get('ref') : undefined;

      let focused = false;
      let cache;
      let resultsTimer;
      let checking = false;
      let startTime = 0;

      const divSendVerification = document.getElementById('send-verification');
      const divOr = document.getElementById('or');
      const btnUrl = document.getElementById('btn-url');
      const divVeriff = document.getElementById('veriff-root');

      try {
        //let date = new Date('2000/01/01');
        //document.getElementById('birth_date').valueAsDate = date;        
      } catch (error) {

      }

      const divStatus = $('#status');
      const divStatus2 = $('#status2');

      if (!hasRef) {
        divSendVerification.classList.remove("d-none");
        //divOr.classList.remove("d-none");
      }

      const TEST_API_KEY = '45d898bf-50c1-4c39-9216-71d07904ba30';
      const PROD_API_KEY = 'defbb5fe-8c43-446f-847c-bf1e49dba3bf';

      const cancelTimer = () => {
        if (resultsTimer) {
          try {
            clearTimeout(resultsTimer);
          } catch (error) {}
          resultsTimer = undefined;
        }
      }

      const setOutput = (html) => {
        divStatus.html(html);
      }

      const getAPIData = async (endpoint, params, method = 'get', responseType) => {
        let headers = {};
        let data;

        if (!method) {
          method = 'get';
        } else {
          method = method.toLowerCase();
        }

        let url = `${BASE_URL}${endpoint}`;
        let options = {
          method: method,
          headers: headers,
        };

        if (params) {
          if (method === 'post' || method === 'put' || method === 'patch') {
            options.body = JSON.stringify(params);
            if (!headers['content-type']) {
              headers['content-type'] = 'application/json';
            }
          } else {
            url = `${url}?${new URLSearchParams(params)}`;
          }
        }

        let response;
        try {
          response = await fetch(url, options);
          const getData = async () => {
            data = await response.text();
            if (data && data.length > 1) {
              try {
                let firstChar = data.substring(0, 1);

                if (firstChar === '[' || firstChar === '{') {
                  data = JSON.parse(data);
                }
              } catch (e) {}
            }
          }

          if (response) {
            if (response.ok) {
              if (responseType === 'blob') {
                data = await response.blob();
              } else {
                await getData();
              }
            } else {
              await getData();
            }
          }
        } catch (error) {
          console.log(error.message);
        }
        return data;
      }

      const getRequestStatus = async () => {
        if (checking || !focused || !transaction_id) {
          return;
        }

        if (startTime === 0) {
          startTime = Date.now();
        }

        let duration = Date.now() - startTime;
        // if (duration > 180000) {
        //   setOutput('Took too long. Please try again.', 0);
        //   transaction_id = undefined;
        //   return;
        // }

        try {
          checking = true;
          let count = Math.round(duration / 1000);
          if (count > 0 && count % 2 === 0) {
            //dotCount++;
            //console.log(dotCount);
          }
          // let line = '<img src="loader.gif"> Checking...' + ''.padEnd(dotCount, '.');
          // setOutput(line, 0);

          let results = await getAPIData(`/check-request/${transaction_id}`);
          if (results) {
            // if (results.id) {
            //   transaction_id = results.id;
            // }

            let status = results.status;
            if (status) {
              if (status === 'submitted' && MODE === 'DEV') {
                transaction_id = undefined;
                status = "Done. In development mode.";
              } else if (status === 'approved') {
                transaction_id = undefined;
                status =
                  `<h1><span style="color:white;background-color:#42C27D;padding:10px 20px">AUTHENTICATED</span></h1>`;
                  
                if (results.redirect_url && hasRef) {
                  status +=
                    `<br/><br/><button id="btn-redirect"  data-url="${results.redirect_url}" class="btn btn-primary">Continue</button>`
                }

              } else if (status === 'declined') {
                transaction_id = undefined;
                status =
                  `<h1><span style="color:white;background-color: red;padding:10px 20px">DECLINED</span></h1>`;
              } else if (status === 'error') {

              }

              if (results.reason) {
                status = `${status}<br/>${results.reason}`;
              }

              divStatus2.html(`${status}`);
            }
            //console.log(results);
          }
        } catch (error) {
          console.log(error);
        }

        if (transaction_id) {
          cancelTimer();
          resultsTimer = setTimeout(() => {
            getRequestStatus();
          }, 2000);
        } else {
          setOutput('Finished.');
        }
        checking = false;
      }

      const veriff = Veriff({
        host: 'https://stationapi.veriff.com',
        apiKey: MODE === 'PROD' ? PROD_API_KEY : TEST_API_KEY,
        parentId: 'veriff-root',

        onSession: function (err, response) {
          cache = response;
          //console.log(cache);
          //transaction_id = response.verification.id;
          window.veriffSDK.createVeriffFrame({
            url: response.verification.url,
            onEvent: function (msg) {
              let text;
              switch (msg) {
                case 'STARTED':
                  text = 'Started';
                  break;
                case 'CANCELED':
                  text = 'Canceled';
                  break;
                case 'FINISHED':
                  //TODO! Start polling
                  text = '<img src="/images/loader.gif"> Finished. Please wait...';
                  divVeriff.classList.add("d-none");
                  focused = true;
                  getRequestStatus();
                  break;
              }
              if (text) {
                setOutput(`<strong>${text}</strong>`);
              }
            }
          });
        }
      });

      if (hasRef) {
        veriff.setParams({
          person: {
            givenName: ' ',
            lastName: ' '
          },
          vendorData: transaction_id
        });

        veriff.mount();
        document.getElementById('veriff-submit-btn').addEventListener("click", async () => {
          divOr.classList.add("d-none");
          divSendVerification.classList.add("d-none");
        })
      }

      document.addEventListener('visibilitychange', (ev) => {
        focused = document.visibilityState === 'visible';
        if (focused) {
          //startTime = Date.now();
          //getRequestStatus();
        }
      });

      $(document).on('click', '#btn-redirect', (event) => {
        window.location = $('#btn-redirect').data('url');
      });

      btnUrl.addEventListener("click", async () => {
        cancelTimer();

        let data = {
          transaction_id: transaction_id,
          full_name: $('#full_name').val(),
          email_address: $('#email_address').val() || '',
          phone_number: $('#phone_number').val() || '',
          birth_date: $('#birth_date').val() || '',
          request_reference: $('#request_reference').val(),
          redirect_url: $('#redirect_url').val(),
        };

        if (data.email_address.length < 3 && data.phone_number.length < 9) {
          setOutput('<span style="color:red;">Email or phone number required</span>')
          return;
        }

        setOutput('&nbsp;');
        //divOr.classList.add("d-none");
        divVeriff.classList.add("d-none");

        let results = await getAPIData('/generate-url', data, 'post');
        console.log(results);
        if (typeof (results) !== 'object' || results.status === 'error') {
          setOutput(`<span style="color:red;">ERROR: ${JSON.stringify(results)}</span>`);
        } else {
          divSendVerification.classList.add("d-none");

          transaction_id = results.transaction_id;
          setOutput(`<img src="/images/loader.gif"> Verification sent. Please wait...`);
          resultsTimer = setTimeout(() => {
            focused = true;
            getRequestStatus();
          }, 15000);
        }
      });

    })();
  </script>

</body>

</html>